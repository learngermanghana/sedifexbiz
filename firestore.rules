service cloud.firestore {
  match /databases/{database}/documents {
    function getRequesterMembership() {
      return request.auth != null
        ? get(/databases/$(database)/documents/teamMembers/$(request.auth.uid))
        : null;
    }

    function membershipExists(member) {
      return member != null && member.exists();
    }

    function memberStoreId(member) {
      return membershipExists(member) && member.data.storeId is string && member.data.storeId != ''
        ? member.data.storeId
        : null;
    }

    function memberRole(member) {
      return membershipExists(member) && member.data.role is string && member.data.role != ''
        ? member.data.role
        : null;
    }

    function isOwner(member) {
      return memberRole(member) == 'owner';
    }

    function hasStaffAccess(member) {
      let role = memberRole(member);
      return role == 'owner' || role == 'staff';
    }

    function matchesMemberStore(member, storeId) {
      let store = memberStoreId(member);
      return store != null && store == storeId;
    }

    function hasStoreAccess(member, storeId) {
      return hasStaffAccess(member) && matchesMemberStore(member, storeId);
    }

    function hasOwnerAccess(member, storeId) {
      return isOwner(member) && matchesMemberStore(member, storeId);
    }

    function dataHasStore(data) {
      return data.keys().hasAll(['storeId']) && data.storeId is string && data.storeId != '';
    }

    function requestRoleIsValid() {
      return request.resource.data.role is string
        && (request.resource.data.role == 'owner' || request.resource.data.role == 'staff');
    }

    function requestUidMatches(memberId) {
      return !request.resource.data.keys().hasAny(['uid']) || request.resource.data.uid == memberId;
    }

    function canReadStoreDocument(storeId) {
      let member = getRequesterMembership();
      return hasStoreAccess(member, storeId);
    }

    function canManageStoreDocument(storeId) {
      let member = getRequesterMembership();
      return hasOwnerAccess(member, storeId);
    }

    function canReadStoreResource() {
      return dataHasStore(resource.data) && hasStoreAccess(getRequesterMembership(), resource.data.storeId);
    }

    function canCreateStoreResource() {
      return dataHasStore(request.resource.data)
        && hasStoreAccess(getRequesterMembership(), request.resource.data.storeId);
    }

    function canUpdateStoreResource() {
      return dataHasStore(resource.data)
        && dataHasStore(request.resource.data)
        && resource.data.storeId == request.resource.data.storeId
        && hasStoreAccess(getRequesterMembership(), resource.data.storeId);
    }

    function canOwnerCreateStoreResource() {
      return dataHasStore(request.resource.data)
        && hasOwnerAccess(getRequesterMembership(), request.resource.data.storeId);
    }

    function canOwnerWriteStoreResource() {
      return dataHasStore(resource.data)
        && hasOwnerAccess(getRequesterMembership(), resource.data.storeId);
    }

    match /teamMembers/{memberId} {
      allow read: if resource != null
        && resource.data.keys().hasAll(['storeId'])
        && (
          (request.auth != null && request.auth.uid == memberId && membershipExists(getRequesterMembership()))
          || hasOwnerAccess(getRequesterMembership(), resource.data.storeId)
        );

      allow create: if request.auth != null
        && requestUidMatches(memberId)
        && dataHasStore(request.resource.data)
        && requestRoleIsValid()
        && (
          (
            membershipExists(getRequesterMembership())
            && hasOwnerAccess(getRequesterMembership(), request.resource.data.storeId)
          )
          || (
            !membershipExists(getRequesterMembership())
            && request.auth.uid == memberId
            && request.resource.data.role == 'owner'
          )
        );

      allow update: if request.auth != null
        && requestUidMatches(memberId)
        && dataHasStore(resource.data)
        && dataHasStore(request.resource.data)
        && resource.data.storeId == request.resource.data.storeId
        && membershipExists(getRequesterMembership())
        && hasOwnerAccess(getRequesterMembership(), resource.data.storeId)
        && requestRoleIsValid();

      allow delete: if request.auth != null
        && dataHasStore(resource.data)
        && membershipExists(getRequesterMembership())
        && hasOwnerAccess(getRequesterMembership(), resource.data.storeId);
    }

    match /stores/{storeId} {
      allow read: if canReadStoreDocument(storeId);
      allow write: if canManageStoreDocument(storeId);

      match /{document=**} {
        allow read: if canReadStoreDocument(storeId);
        allow write: if canManageStoreDocument(storeId);
      }
    }

    match /products/{productId} {
      allow read: if canReadStoreResource();
      allow create: if canOwnerCreateStoreResource();
      allow update: if canUpdateStoreResource();
      allow delete: if canOwnerWriteStoreResource();
    }

    match /sales/{saleId} {
      allow read: if canReadStoreResource();
      allow create: if canCreateStoreResource();
      allow update: if canUpdateStoreResource();
      allow delete: if canOwnerWriteStoreResource();
    }

    match /saleItems/{saleItemId} {
      allow read: if canReadStoreResource();
      allow create: if canCreateStoreResource();
      allow update: if canUpdateStoreResource();
      allow delete: if canOwnerWriteStoreResource();
    }

    match /ledger/{entryId} {
      allow read: if canReadStoreResource();
      allow create: if canCreateStoreResource();
      allow update: if canUpdateStoreResource();
      allow delete: if canOwnerWriteStoreResource();
    }

    match /stock/{entryId} {
      allow read: if canReadStoreResource();
      allow create: if canCreateStoreResource();
      allow update: if canUpdateStoreResource();
      allow delete: if canOwnerWriteStoreResource();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
